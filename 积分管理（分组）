<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç§¯åˆ†ç®¡ç†ç³»ç»Ÿï¼ˆåˆ†ç»„ç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-5">
        <!-- å¤´éƒ¨åŠŸèƒ½åŒº -->
        <div class="flex flex-wrap gap-3 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 w-full">å­¦ç”Ÿç§¯åˆ†æ’è¡Œæ¦œï¼ˆåˆ†ç»„ç‰ˆï¼‰</h1>
            <div id="current-date" class="text-gray-600 font-medium"></div>
            
            <button onclick="showAddGroupModal()" class="bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600 transition">æ–°å¢å°ç»„</button>
            <button onclick="showAddStudentModal()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition">æ–°å¢å­¦ç”Ÿ</button>
            
            <button onclick="importExcel()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">å¯¼å…¥å­¦ç”Ÿåå•(Excel)</button>
            <button onclick="importScores()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">å¯¼å…¥ç§¯åˆ†æ•°æ®</button>
            <button onclick="exportScores()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">å¯¼å‡ºè¯¦ç»†ç§¯åˆ†</button>
            <button onclick="saveData()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition">ä¿å­˜å½“å‰æ•°æ®</button>
            <button onclick="window.print()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">æ‰“å°ç§¯åˆ†æ¦œ</button>
            <button onclick="undoLastAction()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition" id="undo-btn" disabled>æ’¤é”€ä¸Šä¸€æ­¥</button>
            
            <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden">
            <input type="file" id="score-file" accept=".json" class="hidden">
        </div>

        <!-- å°ç»„ç§¯åˆ†æ¦œåŒºåŸŸ -->
        <div id="group-container" class="space-y-6"></div>
    </div>

    <!-- æ–°å¢å°ç»„å¼¹çª— -->
    <div id="add-group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg w-80">
            <h3 class="text-xl font-bold mb-4">æ–°å¢å°ç»„</h3>
            <input type="text" id="new-group-name" placeholder="è¯·è¾“å…¥å°ç»„åç§°" class="w-full p-2 border border-gray-300 rounded mb-4">
            <div class="flex gap-2">
                <button onclick="addGroup()" class="flex-1 bg-green-500 text-white py-2 rounded">ç¡®è®¤æ·»åŠ </button>
                <button onclick="hideAddGroupModal()" class="flex-1 bg-gray-300 py-2 rounded">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å°ç»„åç§°å¼¹çª— -->
    <div id="edit-group-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg w-80">
            <h3 class="text-xl font-bold mb-4">ä¿®æ”¹å°ç»„åç§°</h3>
            <input type="text" id="edit-group-name" placeholder="è¯·è¾“å…¥æ–°çš„å°ç»„åç§°" class="w-full p-2 border border-gray-300 rounded mb-4">
            <input type="hidden" id="edit-group-id"> <!-- ç”¨äºå­˜å‚¨å½“å‰ç¼–è¾‘çš„å°ç»„ID -->
            <div class="flex gap-2">
                <button onclick="saveGroupName()" class="flex-1 bg-green-500 text-white py-2 rounded">ä¿å­˜ä¿®æ”¹</button>
                <button onclick="hideEditGroupModal()" class="flex-1 bg-gray-300 py-2 rounded">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å­¦ç”Ÿå¼¹çª— -->
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg w-80">
            <h3 class="text-xl font-bold mb-4">æ–°å¢å­¦ç”Ÿ</h3>
            <select id="student-group" class="w-full p-2 border border-gray-300 rounded mb-4">
                <option value="">è¯·é€‰æ‹©å°ç»„</option>
            </select>
            <input type="text" id="new-student-name" placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å" class="w-full p-2 border border-gray-300 rounded mb-4">
            <div class="flex gap-2">
                <button onclick="addStudent()" class="flex-1 bg-green-500 text-white py-2 rounded">ç¡®è®¤æ·»åŠ </button>
                <button onclick="hideAddStudentModal()" class="flex-1 bg-gray-300 py-2 rounded">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // åˆå§‹åŒ–æ•°æ®ç»“æ„
        let groupData = JSON.parse(localStorage.getItem('groupData')) || [];
        let studentData = JSON.parse(localStorage.getItem('studentScores')) || [];
        let scoreRecords = JSON.parse(localStorage.getItem('scoreRecords')) || {};
        let actionHistory = [];
        const MAX_HISTORY = 10;

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('current-date').textContent = `å½“å‰æ—¥æœŸï¼š${today.toLocaleDateString()}`;
            renderGroups();
            updateUndoButton();
        });

        // æ¸²æŸ“æ‰€æœ‰å°ç»„
        function renderGroups() {
            const container = document.getElementById('group-container');
            container.innerHTML = '';

            if (groupData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-lg shadow">
                        <p class="text-gray-500">æš‚æ— å°ç»„æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ–°å¢å°ç»„"åˆ›å»ºç¬¬ä¸€ä¸ªå°ç»„</p>
                    </div>
                `;
                return;
            }

            groupData.forEach(group => {
                const groupStudents = [...studentData]
                    .filter(student => student.groupId === group.id)
                    .sort((a, b) => b.score - a.score);

                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white rounded-lg shadow p-5';
                
                groupCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            ğŸ« ${group.name} 
                            <span class="ml-2 text-sm font-normal text-gray-500">(${groupStudents.length}äºº)</span>
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="showEditGroupModal('${group.id}', '${group.name}')" 
                                    class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition">
                                ç¼–è¾‘ç»„å
                            </button>
                            <button onclick="deleteGroup('${group.id}')" 
                                    class="text-sm bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition">
                                åˆ é™¤å°ç»„
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        ${groupStudents.length > 0 ? '' : `
                            <div class="col-span-full text-center py-4 text-gray-500">
                                è¯¥å°ç»„æš‚æ— å­¦ç”Ÿï¼Œè¯·æ·»åŠ å­¦ç”Ÿ
                            </div>
                        `}
                        
                        ${groupStudents.map((student, index) => {
                            const topIcon = index < 3 ? `<span class="text-yellow-500 mr-1">ğŸ‘</span>` : '';
                            return `
                                <div class="p-3 border rounded-lg ${index < 3 ? 'border-yellow-400' : 'border-gray-200'}">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">${topIcon}${student.name}</span>
                                        <span class="font-bold ${index < 3 ? 'text-yellow-600' : 'text-gray-700'}">${student.score}åˆ†</span>
                                    </div>
                                    <div class="flex gap-1 mt-2">
                                        <button onclick="updateScore('${student.id}', 1)" class="flex-1 bg-green-500 text-white text-xs py-1 rounded">+1</button>
                                        <button onclick="updateScore('${student.id}', -1)" class="flex-1 bg-red-500 text-white text-xs py-1 rounded">-1</button>
                                        <button onclick="deleteStudent('${student.id}')" class="bg-gray-200 text-gray-700 text-xs px-1 rounded">Ã—</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.appendChild(groupCard);
            });

            updateGroupSelectOptions();
        }

        // æ˜¾ç¤ºç¼–è¾‘å°ç»„åç§°å¼¹çª—
        function showEditGroupModal(groupId, currentName) {
            document.getElementById('edit-group-id').value = groupId;
            document.getElementById('edit-group-name').value = currentName;
            document.getElementById('edit-group-modal').classList.remove('hidden');
            document.getElementById('edit-group-name').focus();
        }

        // éšè—ç¼–è¾‘å°ç»„åç§°å¼¹çª—
        function hideEditGroupModal() {
            document.getElementById('edit-group-modal').classList.add('hidden');
            document.getElementById('edit-group-id').value = '';
            document.getElementById('edit-group-name').value = '';
        }

        // ä¿å­˜ä¿®æ”¹åçš„å°ç»„åç§°
        function saveGroupName() {
            const groupId = document.getElementById('edit-group-id').value;
            const newName = document.getElementById('edit-group-name').value.trim();
            
            if (!groupId) {
                alert('æœªæ‰¾åˆ°å°ç»„ä¿¡æ¯');
                return;
            }
            
            if (!newName) {
                alert('å°ç»„åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const group = groupData.find(g => g.id === groupId);
            if (group.name === newName) {
                // åç§°æœªæ”¹å˜ï¼Œç›´æ¥å…³é—­å¼¹çª—
                hideEditGroupModal();
                return;
            }
            
            // è®°å½•æ“ä½œå†å²ç”¨äºæ’¤é”€
            saveActionHistory();
            
            // æ›´æ–°å°ç»„åç§°
            group.name = newName;
            
            renderGroups();
            saveData();
            updateUndoButton();
            hideEditGroupModal();
            alert('å°ç»„åç§°å·²æ›´æ–°');
        }

        // å…¶ä»–åŠŸèƒ½ä»£ç ä¿æŒä¸å˜ï¼ˆæ–°å¢å°ç»„ã€æ–°å¢å­¦ç”Ÿã€ç§¯åˆ†æ“ä½œç­‰ï¼‰
        function updateGroupSelectOptions() {
            const select = document.getElementById('student-group');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å°ç»„</option>';
            groupData.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
            
            if (currentValue) select.value = currentValue;
        }

        function addGroup() {
            const groupName = document.getElementById('new-group-name').value.trim();
            if (!groupName) {
                alert('è¯·è¾“å…¥å°ç»„åç§°');
                return;
            }

            saveActionHistory();
            
            groupData.push({
                id: 'group_' + Date.now(),
                name: groupName
            });

            renderGroups();
            saveData();
            updateUndoButton();
            hideAddGroupModal();
        }

        function deleteGroup(groupId) {
            const group = groupData.find(g => g.id === groupId);
            const groupStudents = studentData.filter(s => s.groupId === groupId);
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${group.name}"å—ï¼Ÿè¯¥å°ç»„çš„${groupStudents.length}åå­¦ç”Ÿä¹Ÿä¼šè¢«åˆ é™¤`)) {
                return;
            }

            saveActionHistory();
            
            groupData = groupData.filter(g => g.id !== groupId);
            studentData = studentData.filter(s => s.groupId !== groupId);
            Object.keys(scoreRecords).forEach(date => {
                groupStudents.forEach(student => {
                    delete scoreRecords[date][student.id];
                });
            });

            renderGroups();
            saveData();
            updateUndoButton();
        }

        function addStudent() {
            const groupId = document.getElementById('student-group').value;
            const studentName = document.getElementById('new-student-name').value.trim();
            
            if (!groupId) {
                alert('è¯·é€‰æ‹©æ‰€å±å°ç»„');
                return;
            }
            if (!studentName) {
                alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
                return;
            }

            saveActionHistory();
            
            studentData.push({
                id: 'student_' + Date.now(),
                name: studentName,
                score: 0,
                groupId: groupId
            });

            renderGroups();
            saveData();
            updateUndoButton();
            hideAddStudentModal();
        }

        function deleteStudent(studentId) {
            const student = studentData.find(s => s.id === studentId);
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å­¦ç”Ÿ"${student.name}"å—ï¼Ÿ`)) {
                return;
            }

            saveActionHistory();
            
            studentData = studentData.filter(s => s.id !== studentId);
            Object.keys(scoreRecords).forEach(date => {
                delete scoreRecords[date][studentId];
            });

            renderGroups();
            saveData();
            updateUndoButton();
        }

        function updateScore(studentId, change) {
            saveActionHistory();
            
            const today = new Date().toLocaleDateString();
            const student = studentData.find(s => s.id === studentId);
            
            if (student) {
                student.score = Math.max(0, student.score + change);
                
                if (!scoreRecords[today]) scoreRecords[today] = {};
                if (!scoreRecords[today][studentId]) scoreRecords[today][studentId] = 0;
                scoreRecords[today][studentId] += change;
                
                renderGroups();
                saveData();
                updateUndoButton();
            }
        }

        function importExcel() {
            document.getElementById('excel-file').click();
            document.getElementById('excel-file').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    saveActionHistory();
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const students = XLSX.utils.sheet_to_json(firstSheet);

                    students.forEach(student => {
                        let groupId;
                        if (student.group) {
                            const existingGroup = groupData.find(g => g.name === student.group);
                            if (existingGroup) {
                                groupId = existingGroup.id;
                            } else {
                                const newGroupId = 'group_' + Date.now();
                                groupData.push({ id: newGroupId, name: student.group });
                                groupId = newGroupId;
                            }
                        } else {
                            if (groupData.length === 0) {
                                const newGroupId = 'group_' + Date.now();
                                groupData.push({ id: newGroupId, name: 'é»˜è®¤å°ç»„' });
                                groupId = newGroupId;
                            } else {
                                groupId = groupData[0].id;
                            }
                        }

                        studentData.push({
                            id: 'student_' + Date.now() + Math.random().toString(36).substr(2, 5),
                            name: student.name || 'æœªå‘½å',
                            score: 0,
                            groupId: groupId
                        });
                    });

                    renderGroups();
                    saveData();
                    updateUndoButton();
                    alert(`æˆåŠŸå¯¼å…¥${students.length}åå­¦ç”Ÿ`);
                };
                reader.readAsArrayBuffer(file);
            };
        }

        function showAddGroupModal() {
            document.getElementById('add-group-modal').classList.remove('hidden');
            document.getElementById('new-group-name').focus();
        }

        function hideAddGroupModal() {
            document.getElementById('add-group-modal').classList.add('hidden');
            document.getElementById('new-group-name').value = '';
        }

        function showAddStudentModal() {
            document.getElementById('add-student-modal').classList.remove('hidden');
            document.getElementById('new-student-name').focus();
        }

        function hideAddStudentModal() {
            document.getElementById('add-student-modal').classList.add('hidden');
            document.getElementById('new-student-name').value = '';
        }

        function saveActionHistory() {
            const historyItem = {
                groupData: JSON.parse(JSON.stringify(groupData)),
                studentData: JSON.parse(JSON.stringify(studentData)),
                scoreRecords: JSON.parse(JSON.stringify(scoreRecords))
            };
            
            actionHistory.push(historyItem);
            if (actionHistory.length > MAX_HISTORY) {
                actionHistory.shift();
            }
            
            updateUndoButton();
        }

        function undoLastAction() {
            if (actionHistory.length > 0) {
                const lastState = actionHistory.pop();
                groupData = lastState.groupData;
                studentData = lastState.studentData;
                scoreRecords = lastState.scoreRecords;
                
                renderGroups();
                saveData();
                updateUndoButton();
                alert('å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ');
            }
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undo-btn');
            undoBtn.disabled = actionHistory.length === 0;
            undoBtn.classList.toggle('opacity-50', actionHistory.length === 0);
            undoBtn.classList.toggle('cursor-not-allowed', actionHistory.length === 0);
        }

        function exportScores() {
            const exportData = {
                exportDate: new Date().toLocaleString(),
                groups: groupData,
                students: studentData,
                dailyRecords: scoreRecords,
                weeklySummary: getWeeklySummary(),
                monthlySummary: getMonthlySummary()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `å­¦ç”Ÿç§¯åˆ†æ˜ç»†_${new Date().toLocaleDateString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importScores() {
            document.getElementById('score-file').click();
            document.getElementById('score-file').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    saveActionHistory();
                    
                    const data = JSON.parse(e.target.result);
                    groupData = data.groups || [];
                    studentData = data.students || [];
                    scoreRecords = data.records || data.dailyRecords || {};
                    
                    renderGroups();
                    saveData();
                    updateUndoButton();
                    alert('ç§¯åˆ†æ•°æ®å¯¼å…¥æˆåŠŸ');
                };
                reader.readAsText(file);
            };
        }

        function getWeeklySummary() {
            const summary = {};
            Object.keys(scoreRecords).forEach(date => {
                const week = new Date(date).toLocaleDateString('zh-CN', { week: 'numeric', year: 'numeric' });
                if (!summary[week]) summary[week] = {};
                
                Object.keys(scoreRecords[date]).forEach(studentId => {
                    const student = studentData.find(s => s.id === studentId);
                    if (student) {
                        const group = groupData.find(g => g.id === student.groupId);
                        const key = `${group ? group.name + '-' : ''}${student.name}`;
                        if (!summary[week][key]) summary[week][key] = 0;
                        summary[week][key] += scoreRecords[date][studentId];
                    }
                });
            });
            return summary;
        }

        function getMonthlySummary() {
            const summary = {};
            Object.keys(scoreRecords).forEach(date => {
                const month = new Date(date).toLocaleDateString('zh-CN', { month: 'long', year: 'numeric' });
                if (!summary[month]) summary[month] = {};
                
                Object.keys(scoreRecords[date]).forEach(studentId => {
                    const student = studentData.find(s => s.id === studentId);
                    if (student) {
                        const group = groupData.find(g => g.id === student.groupId);
                        const key = `${group ? group.name + '-' : ''}${student.name}`;
                        if (!summary[month][key]) summary[month][key] = 0;
                        summary[month][key] += scoreRecords[date][studentId];
                    }
                });
            });
            return summary;
        }

        function saveData() {
            localStorage.setItem('groupData', JSON.stringify(groupData));
            localStorage.setItem('studentScores', JSON.stringify(studentData));
            localStorage.setItem('scoreRecords', JSON.stringify(scoreRecords));
        }
    </script>
</body>
</html>
