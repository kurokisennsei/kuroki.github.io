<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学生积分榜</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入SheetJS用于Excel处理 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#F59E0B',
            danger: '#EF4444',
            dark: '#1F2937',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .student-card {
        @apply bg-white rounded-xl shadow-md p-4 transition-all duration-300 hover:shadow-lg;
      }
      .podium-1 {
        @apply bg-gradient-to-br from-yellow-100 to-yellow-200 border-2 border-yellow-400;
      }
      .podium-2 {
        @apply bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-400;
      }
      .podium-3 {
        @apply bg-gradient-to-br from-orange-100 to-orange-200 border-2 border-orange-500;
      }
      .btn-action {
        @apply px-4 py-2 rounded-lg font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center mb-4 md:mb-0">
        <i class="fa fa-trophy text-accent text-3xl mr-3"></i>
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">学生积分榜</h1>
      </div>
      
      <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
        <div class="bg-gray-100 rounded-lg px-4 py-2 text-dark font-medium flex items-center">
          <i class="fa fa-calendar-o mr-2 text-primary"></i>
          <span id="current-date"></span>
        </div>
        
        <div class="flex flex-wrap justify-center gap-2 w-full md:w-auto">
          <button id="save-btn" class="btn-action bg-primary text-white hover:bg-primary/90 focus:ring-primary">
            <i class="fa fa-save mr-1"></i> 保存
          </button>
          <button id="print-btn" class="btn-action bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500">
            <i class="fa fa-print mr-1"></i> 打印
          </button>
          <button id="import-students-btn" class="btn-action bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary">
            <i class="fa fa-users mr-1"></i> 导入名单
          </button>
          <button id="import-data-btn" class="btn-action bg-accent text-white hover:bg-accent/90 focus:ring-accent">
            <i class="fa fa-upload mr-1"></i> 导入积分
          </button>
          <button id="export-data-btn" class="btn-action bg-purple-600 text-white hover:bg-purple-700 focus:ring-purple-500">
            <i class="fa fa-download mr-1"></i> 导出积分
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- 统计信息 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="flex items-center">
          <div class="bg-blue-100 p-3 rounded-full mr-4">
            <i class="fa fa-user-circle-o text-primary text-2xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">总学生数</p>
            <p id="total-students" class="text-2xl font-bold text-dark">0</p>
          </div>
        </div>
        <div class="flex items-center">
          <div class="bg-green-100 p-3 rounded-full mr-4">
            <i class="fa fa-line-chart text-secondary text-2xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">总积分</p>
            <p id="total-points" class="text-2xl font-bold text-dark">0</p>
          </div>
        </div>
        <div class="flex items-center">
          <div class="bg-yellow-100 p-3 rounded-full mr-4">
            <i class="fa fa-calendar-check-o text-accent text-2xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">记录日期范围</p>
            <p id="date-range" class="text-2xl font-bold text-dark">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 积分榜标题 -->
    <div class="mb-6 text-center">
      <h2 class="text-[clamp(1.2rem,2vw,1.8rem)] font-bold text-dark">当前积分排名</h2>
      <p class="text-gray-500 mt-1">更新时间: <span id="last-updated">从未更新</span></p>
    </div>

    <!-- 学生列表 -->
    <div id="students-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
      <!-- 学生卡片将通过JavaScript动态生成 -->
      <div class="col-span-full flex items-center justify-center py-16 text-gray-400">
        <div class="text-center">
          <i class="fa fa-folder-open-o text-5xl mb-3"></i>
          <p>还没有学生数据，请导入学生名单</p>
        </div>
      </div>
    </div>

    <!-- 添加学生表单 -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <h3 class="text-xl font-bold text-dark mb-4">添加学生</h3>
      <div class="flex flex-col sm:flex-row gap-3">
        <input type="text" id="new-student-name" placeholder="输入学生姓名" 
               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
        <button id="add-student-btn" class="btn-action bg-primary text-white hover:bg-primary/90 focus:ring-primary whitespace-nowrap">
          <i class="fa fa-plus mr-1"></i> 添加学生
        </button>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark text-white py-6">
    <div class="container mx-auto px-4 text-center">
      <p>© <span id="current-year"></span> 学生积分管理系统 | 设计与开发</p>
      <p class="text-gray-400 text-sm mt-1">使用最新数据技术，高效管理学生积分</p>
    </div>
  </footer>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-5 right-5 bg-dark text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
    <i id="notification-icon" class="fa fa-check-circle mr-2"></i>
    <span id="notification-message"></span>
  </div>

  <script>
    // 全局数据存储
    let students = [];
    const STORAGE_KEY = 'student_scores';
    
    // DOM 元素
    const studentsContainer = document.getElementById('students-container');
    const addStudentBtn = document.getElementById('add-student-btn');
    const newStudentName = document.getElementById('new-student-name');
    const saveBtn = document.getElementById('save-btn');
    const printBtn = document.getElementById('print-btn');
    const importStudentsBtn = document.getElementById('import-students-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const exportDataBtn = document.getElementById('export-data-btn');
    const currentDateEl = document.getElementById('current-date');
    const lastUpdatedEl = document.getElementById('last-updated');
    const totalStudentsEl = document.getElementById('total-students');
    const totalPointsEl = document.getElementById('total-points');
    const dateRangeEl = document.getElementById('date-range');
    const currentYearEl = document.getElementById('current-year');
    const notification = document.getElementById('notification');
    const notificationIcon = document.getElementById('notification-icon');
    const notificationMessage = document.getElementById('notification-message');
    
    // 初始化
    function init() {
      // 设置日期
      const now = new Date();
      currentDateEl.textContent = formatDate(now);
      currentYearEl.textContent = now.getFullYear();
      
      // 从本地存储加载数据
      loadData();
      
      // 事件监听
      addStudentBtn.addEventListener('click', addStudent);
      newStudentName.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addStudent();
      });
      saveBtn.addEventListener('click', saveData);
      printBtn.addEventListener('click', printScores);
      importStudentsBtn.addEventListener('click', () => {
        document.getElementById('import-students-input').click();
      });
      importDataBtn.addEventListener('click', () => {
        document.getElementById('import-data-input').click();
      });
      exportDataBtn.addEventListener('click', exportData);
      
      // 创建隐藏的文件输入
      createFileInputs();
    }
    
    // 创建隐藏的文件输入元素
    function createFileInputs() {
      // 导入学生名单
      const importStudentsInput = document.createElement('input');
      importStudentsInput.id = 'import-students-input';
      importStudentsInput.type = 'file';
      importStudentsInput.accept = '.xlsx, .xls, .csv';
      importStudentsInput.style.display = 'none';
      importStudentsInput.addEventListener('change', importStudents);
      document.body.appendChild(importStudentsInput);
      
      // 导入积分数据
      const importDataInput = document.createElement('input');
      importDataInput.id = 'import-data-input';
      importDataInput.type = 'file';
      importDataInput.accept = '.xlsx, .xls, .csv';
      importDataInput.style.display = 'none';
      importDataInput.addEventListener('change', importData);
      document.body.appendChild(importDataInput);
    }
    
    // 添加学生
    function addStudent() {
      const name = newStudentName.value.trim();
      if (!name) {
        showNotification('请输入学生姓名', 'warning');
        return;
      }
      
      // 检查是否已存在同名学生
      if (students.some(student => student.name === name)) {
        showNotification('该学生已存在', 'warning');
        return;
      }
      
      const now = new Date();
      const newStudent = {
        id: Date.now(),
        name,
        score: 0,
        history: [],
        createdAt: now.toISOString()
      };
      
      students.push(newStudent);
      newStudentName.value = '';
      renderStudents();
      showNotification(`已添加学生: ${name}`, 'success');
    }
    
    // 渲染学生列表
    function renderStudents() {
      // 按积分降序排序
      students.sort((a, b) => b.score - a.score);
      
      if (students.length === 0) {
        studentsContainer.innerHTML = `
          <div class="col-span-full flex items-center justify-center py-16 text-gray-400">
            <div class="text-center">
              <i class="fa fa-folder-open-o text-5xl mb-3"></i>
              <p>还没有学生数据，请导入学生名单</p>
            </div>
          </div>
        `;
        updateStats();
        return;
      }
      
      studentsContainer.innerHTML = '';
      
      students.forEach((student, index) => {
        const rank = index + 1;
        let podiumClass = '';
        let badgeHtml = '';
        
        // 前三名特殊样式
        if (rank === 1) {
          podiumClass = 'podium-1';
          badgeHtml = '<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center"><i class="fa fa-trophy mr-1"></i> 冠军</div>';
        } else if (rank === 2) {
          podiumClass = 'podium-2';
          badgeHtml = '<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-400 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center"><i class="fa fa-trophy mr-1"></i> 亚军</div>';
        } else if (rank === 3) {
          podiumClass = 'podium-3';
          badgeHtml = '<div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center"><i class="fa fa-trophy mr-1"></i> 季军</div>';
        }
        
        const studentCard = document.createElement('div');
        studentCard.className = `student-card relative ${podiumClass}`;
        studentCard.innerHTML = `
          ${badgeHtml}
          <div class="text-center mb-2">
            <span class="inline-block w-8 h-8 rounded-full bg-primary/10 text-primary font-bold text-lg flex items-center justify-center">
              ${rank}
            </span>
          </div>
          <h3 class="text-lg font-bold text-dark text-center mb-1">${student.name}</h3>
          <div class="text-center mb-3">
            <span class="text-2xl font-bold ${student.score > 0 ? 'text-secondary' : 'text-gray-500'}">${student.score}</span>
            <span class="text-gray-500 ml-1">分</span>
          </div>
          <div class="flex justify-center gap-2">
            <button class="score-btn minus bg-gray-100 hover:bg-danger hover:text-white text-gray-600 p-2 rounded-full transition-colors" 
                    data-id="${student.id}">
              <i class="fa fa-minus"></i>
            </button>
            <button class="score-btn plus bg-gray-100 hover:bg-secondary hover:text-white text-gray-600 p-2 rounded-full transition-colors" 
                    data-id="${student.id}">
              <i class="fa fa-plus"></i>
            </button>
          </div>
          ${rank <= 3 ? '<div class="mt-3 text-center"><span class="text-yellow-500"><i class="fa fa-thumbs-up mr-1"></i> 点赞!</span></div>' : ''}
        `;
        
        studentsContainer.appendChild(studentCard);
      });
      
      // 添加积分按钮事件监听
      document.querySelectorAll('.score-btn.plus').forEach(btn => {
        btn.addEventListener('click', () => {
          updateScore(parseInt(btn.dataset.id), 1);
        });
      });
      
      document.querySelectorAll('.score-btn.minus').forEach(btn => {
        btn.addEventListener('click', () => {
          updateScore(parseInt(btn.dataset.id), -1);
        });
      });
      
      updateStats();
    }
    
    // 更新积分
    function updateScore(studentId, change) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;
      
      // 确保积分不会为负
      if (student.score + change < 0) {
        showNotification('积分不能为负数', 'warning');
        return;
      }
      
      const previousScore = student.score;
      student.score += change;
      
      // 记录积分变动历史
      const now = new Date();
      student.history.push({
        date: now.toISOString().split('T')[0], // 仅保留日期部分
        change,
        previousScore,
        newScore: student.score,
        timestamp: now.toISOString()
      });
      
      renderStudents();
      showNotification(`${student.name} 的积分已${change > 0 ? '增加' : '减少'}`, 'info');
    }
    
    // 保存数据到本地存储
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
      const now = new Date();
      lastUpdatedEl.textContent = formatDateTime(now);
      showNotification('数据已成功保存', 'success');
    }
    
    // 从本地存储加载数据
    function loadData() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        students = JSON.parse(savedData);
        renderStudents();
        
        // 查找最后更新时间
        let lastUpdated = null;
        students.forEach(student => {
          if (student.history.length > 0) {
            const latestHistory = new Date(student.history[student.history.length - 1].timestamp);
            if (!lastUpdated || latestHistory > lastUpdated) {
              lastUpdated = latestHistory;
            }
          }
        });
        
        if (lastUpdated) {
          lastUpdatedEl.textContent = formatDateTime(lastUpdated);
        }
      }
    }
    
    // 打印积分榜
    function printScores() {
      const printWindow = window.open('', '_blank');
      
      // 构建打印内容
      printWindow.document.write(`
        <html>
          <head>
            <title>学生积分榜 - 打印</title>
            <style>
              body { font-family: Arial, sans-serif; }
              .container { width: 90%; margin: 0 auto; }
              .header { text-align: center; margin-bottom: 30px; }
              .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
              .date { color: #666; margin-bottom: 20px; }
              .students-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
              .student-card { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 5px; }
              .rank { font-weight: bold; margin-bottom: 10px; }
              .name { font-size: 16px; margin-bottom: 5px; }
              .score { font-size: 20px; font-weight: bold; color: #22c55e; }
              .podium-1 { border-color: #facc15; background-color: #fffbeb; }
              .podium-2 { border-color: #94a3b8; background-color: #f1f5f9; }
              .podium-3 { border-color: #f97316; background-color: #fff7ed; }
              @media print {
                @page { margin: 1cm; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <div class="title">学生积分榜</div>
                <div class="date">打印日期: ${formatDateTime(new Date())}</div>
                <div class="date">总学生数: ${students.length} | 总积分: ${students.reduce((sum, s) => sum + s.score, 0)}</div>
              </div>
              <div class="students-grid">
                ${students.map((student, index) => {
                  const rank = index + 1;
                  let podiumClass = '';
                  if (rank === 1) podiumClass = 'podium-1';
                  else if (rank === 2) podiumClass = 'podium-2';
                  else if (rank === 3) podiumClass = 'podium-3';
                  
                  return `
                    <div class="student-card ${podiumClass}">
                      <div class="rank">第 ${rank} 名</div>
                      <div class="name">${student.name}</div>
                      <div class="score">${student.score} 分</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }
    
    // 导入学生名单
    function importStudents(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // 假设Excel中包含"姓名"列
          let addedCount = 0;
          jsonData.forEach(item => {
            let name = '';
            // 尝试不同的列名可能性
            if (item.姓名) name = item.姓名.toString().trim();
            else if (item.name) name = item.name.toString().trim();
            else if (item['学生姓名']) name = item['学生姓名'].toString().trim();
            
            if (name && !students.some(s => s.name === name)) {
              students.push({
                id: Date.now() + addedCount,
                name,
                score: 0,
                history: [],
                createdAt: new Date().toISOString()
              });
              addedCount++;
            }
          });
          
          renderStudents();
          showNotification(`成功导入 ${addedCount} 名学生`, 'success');
        } catch (error) {
          showNotification('导入失败: ' + error.message, 'error');
          console.error('导入错误:', error);
        }
        
        // 重置文件输入
        e.target.value = '';
      };
      reader.readAsArrayBuffer(file);
    }
    
    // 导入积分数据
    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          let updatedCount = 0;
          jsonData.forEach(item => {
            let name = '';
            if (item.姓名) name = item.姓名.toString().trim();
            else if (item.name) name = item.name.toString().trim();
            
            if (name && item.积分 !== undefined) {
              const student = students.find(s => s.name === name);
              if (student) {
                const newScore = parseInt(item.积分);
                if (!isNaN(newScore) && newScore >= 0) {
                  const change = newScore - student.score;
                  if (change !== 0) {
                    student.score = newScore;
                    
                    // 记录积分变动
                    const now = new Date();
                    student.history.push({
                      date: now.toISOString().split('T')[0],
                      change,
                      previousScore: student.score - change,
                      newScore: student.score,
                      timestamp: now.toISOString(),
                      imported: true
                    });
                    
                    updatedCount++;
                  }
                }
              }
            }
          });
          
          renderStudents();
          showNotification(`成功更新 ${updatedCount} 名学生的积分`, 'success');
        } catch (error) {
          showNotification('导入失败: ' + error.message, 'error');
          console.error('导入错误:', error);
        }
        
        // 重置文件输入
        e.target.value = '';
      };
      reader.readAsArrayBuffer(file);
    }
    
    // 导出积分数据
    function exportData() {
      if (students.length === 0) {
        showNotification('没有数据可导出', 'warning');
        return;
      }
      
      // 准备导出的主数据
      const mainData = students.map((student, index) => ({
        '排名': index + 1,
        '姓名': student.name,
        '当前积分': student.score,
        '记录次数': student.history.length,
        '首次记录': formatDate(new Date(student.createdAt)),
        '最后更新': student.history.length > 0 
          ? formatDate(new Date(student.history[student.history.length - 1].timestamp))
          : '-'
      }));
      
      // 准备详细的历史记录数据
      const historyData = [];
      students.forEach(student => {
        if (student.history.length > 0) {
          student.history.forEach(record => {
            historyData.push({
              '姓名': student.name,
              '日期': record.date,
              '积分变动': record.change,
              '变动前积分': record.previousScore,
              '变动后积分': record.newScore,
              '时间': new Date(record.timestamp).toLocaleTimeString()
            });
          });
        }
      });
      
      // 准备统计数据
      const statsData = generateStatsData();
      
      // 创建工作簿并添加工作表
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mainData), '当前积分');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(historyData), '积分历史');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(statsData), '积分统计');
      
      // 导出文件
      const today = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `学生积分榜_${today}.xlsx`);
      showNotification('积分数据已成功导出', 'success');
    }
    
    // 生成统计数据
    function generateStatsData() {
      const stats = [];
      
      // 按日期统计
      const dailyStats = {};
      students.forEach(student => {
        student.history.forEach(record => {
          if (!dailyStats[record.date]) {
            dailyStats[record.date] = {
              日期: record.date,
              总加分: 0,
              总减分: 0,
              参与学生数: new Set()
            };
          }
          
          if (record.change > 0) {
            dailyStats[record.date].总加分 += record.change;
          } else {
            dailyStats[record.date].总减分 += Math.abs(record.change);
          }
          
          dailyStats[record.date].参与学生数.add(student.name);
        });
      });
      
      // 转换为数组并计算参与学生数
      Object.values(dailyStats).forEach(day => {
        day.参与学生数 = day.参与学生数.size;
        stats.push(day);
      });
      
      // 按周统计
      const weeklyStats = {};
      stats.forEach(day => {
        const date = new Date(day.日期);
        const year = date.getFullYear();
        const week = getWeekNumber(date);
        const weekKey = `${year}-W${week}`;
        
        if (!weeklyStats[weekKey]) {
          weeklyStats[weekKey] = {
            周期: `${year}年第${week}周`,
            总加分: 0,
            总减分: 0,
            参与学生数: 0
          };
        }
        
        weeklyStats[weekKey].总加分 += day.总加分;
        weeklyStats[weekKey].总减分 += day.总减分;
        weeklyStats[weekKey].参与学生数 = Math.max(weeklyStats[weekKey].参与学生数, day.参与学生数);
      });
      
      // 添加到统计数据
      Object.values(weeklyStats).forEach(week => {
        stats.push({...week, 类型: '周统计'});
      });
      
      // 按月统计
      const monthlyStats = {};
      stats.forEach(day => {
        if (!day.类型) { // 只处理日期数据
          const date = new Date(day.日期);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const monthKey = `${year}-${month}`;
          
          if (!monthlyStats[monthKey]) {
            monthlyStats[monthKey] = {
              周期: `${year}年${month}月`,
              总加分: 0,
              总减分: 0,
              参与学生数: 0
            };
          }
          
          monthlyStats[monthKey].总加分 += day.总加分;
          monthlyStats[monthKey].总减分 += day.总减分;
          monthlyStats[monthKey].参与学生数 = Math.max(monthlyStats[monthKey].参与学生数, day.参与学生数);
        }
      });
      
      // 添加到统计数据
      Object.values(monthlyStats).forEach(month => {
        stats.push({...month, 类型: '月统计'});
      });
      
      return stats;
    }
    
    // 获取周数
    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }
    
    // 更新统计信息
    function updateStats() {
      // 总学生数
      totalStudentsEl.textContent = students.length;
      
      // 总积分
      const totalPoints = students.reduce((sum, student) => sum + student.score, 0);
      totalPointsEl.textContent = totalPoints;
      
      // 日期范围
      if (students.length === 0 || students.every(s => s.history.length === 0)) {
        dateRangeEl.textContent = '-';
        return;
      }
      
      let earliestDate = null;
      let latestDate = null;
      
      students.forEach(student => {
        student.history.forEach(record => {
          const date = new Date(record.date);
          if (!earliestDate || date < earliestDate) {
            earliestDate = date;
          }
          if (!latestDate || date > latestDate) {
            latestDate = date;
          }
        });
      });
      
      if (earliestDate && latestDate) {
        dateRangeEl.textContent = `${formatDate(earliestDate)} - ${formatDate(latestDate)}`;
      }
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      notificationMessage.textContent = message;
      
      // 设置图标和样式
      switch(type) {
        case 'success':
          notificationIcon.className = 'fa fa-check-circle mr-2 text-green-500';
          notification.classList.add('bg-green-50');
          notification.classList.add('text-green-800');
          break;
        case 'error':
          notificationIcon.className = 'fa fa-exclamation-circle mr-2 text-red-500';
          notification.classList.add('bg-red-50');
          notification.classList.add('text-red-800');
          break;
        case 'warning':
          notificationIcon.className = 'fa fa-exclamation-triangle mr-2 text-yellow-500';
          notification.classList.add('bg-yellow-50');
          notification.classList.add('text-yellow-800');
          break;
        default:
          notificationIcon.className = 'fa fa-info-circle mr-2 text-blue-500';
          notification.classList.add('bg-blue-50');
          notification.classList.add('text-blue-800');
      }
      
      // 显示通知
      notification.classList.remove('translate-y-20', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100');
      
      // 3秒后隐藏
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-20', 'opacity-0');
        
        // 清除样式类
        setTimeout(() => {
          notification.classList.remove('bg-green-50', 'text-green-800', 
                                       'bg-red-50', 'text-red-800', 
                                       'bg-yellow-50', 'text-yellow-800', 
                                       'bg-blue-50', 'text-blue-800');
        }, 300);
      }, 3000);
    }
    
    // 格式化日期 (YYYY-MM-DD)
    function formatDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    // 格式化日期时间 (YYYY-MM-DD HH:MM)
    function formatDateTime(date) {
      return `${formatDate(date)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
    
    // 初始化应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>